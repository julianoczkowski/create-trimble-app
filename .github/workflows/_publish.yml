name: Publish to NPM

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write # Required for npm provenance

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run security audit
        run: npm audit --audit-level=high
        continue-on-error: true

  publish:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Test CLI functionality
        run: |
          echo "Testing CLI help command..."
          node bin/create-trimble-app.js --help
          echo "âœ“ Help command works"

          echo "Testing CLI version command..."
          node bin/create-trimble-app.js --version
          echo "âœ“ Version command works"

          echo "Testing CLI info command..."
          node bin/create-trimble-app.js --info
          echo "âœ“ Info command works"

          echo "Testing CLI dry-run..."
          node bin/create-trimble-app.js test-app --framework react --dry-run
          echo "âœ“ Dry-run command works"

      - name: Verify bundled templates
        run: |
          echo "Checking bundled templates..."

          # Check React template
          if [ ! -f "templates/react/package.json" ]; then
            echo "Error: React bundled template not found"
            exit 1
          fi
          echo "âœ“ React bundled template exists"

          # Check Angular template
          if [ ! -f "templates/angular/package.json" ]; then
            echo "Error: Angular bundled template not found"
            exit 1
          fi
          echo "âœ“ Angular bundled template exists"

      - name: Run security audit
        run: npm audit --audit-level=high

      - name: Publish to NPM with provenance
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=v$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: v$VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Create Modus App ${{ steps.get_version.outputs.VERSION }}

            ### Bundled Templates - No External Downloads
            Templates are included directly in this npm package:
            - ğŸ“¦ Works completely offline
            - âš¡ Faster project creation
            - ğŸ”’ No supply chain risks

            ### Features
            - ğŸ¯ **Interactive CLI** - Beautiful interface with framework selection
            - âš›ï¸ **React** - React + Vite + Modus 2.0 Components
            - ğŸ…°ï¸ **Angular** - Angular + Modus 2.0 Web Components
            - ğŸ“¦ **Smart Installation** - Package manager detection
            - ğŸ” **Secure** - Published with npm provenance

            ### Installation

            **Interactive mode:**
            ```bash
            npx @julianoczkowski/create-trimble-app
            ```

            **With project name and framework:**
            ```bash
            npx @julianoczkowski/create-trimble-app my-app --framework react
            ```

            **Preview without creating files:**
            ```bash
            npx @julianoczkowski/create-trimble-app my-app --dry-run
            ```

            ### CLI Options
            | Option | Description |
            |--------|-------------|
            | `--framework <name>` | Specify framework (react, angular) |
            | `--current-folder` | Install in current directory |
            | `--dry-run` | Preview without making changes |
            | `--verbose` | Enable verbose output |
            | `--info` | Show CLI information |
            | `--no-install` | Skip dependency installation |
          draft: false
          prerelease: false
