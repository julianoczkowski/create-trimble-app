---
description: Comprehensive rules for opening and closing Modus modals in Angular. Documents the correct pattern using HTMLDialogElement API and common pitfalls to avoid.
globs: ["**/demos/**/*modal*.ts", "**/*modal*.ts", "**/*modal*.html"]
---

# Modal Usage Rules

Comprehensive rules for opening and closing Modus modals in Angular applications.

---

## ✅ CORRECT: How to Open/Close Modals

### Pattern: Use `document.getElementById()` with HTMLDialogElement

**The Modus modal component creates an HTML `<dialog>` element with the `modalId` as its `id` attribute. Always use the native HTMLDialogElement API to open/close modals.**

```typescript
openModal(): void {
  const dialog = document.getElementById('modal-id') as HTMLDialogElement | null;
  if (dialog && typeof dialog.showModal === 'function') {
    dialog.showModal();
  }
}

closeModal(): void {
  const dialog = document.getElementById('modal-id') as HTMLDialogElement | null;
  if (dialog && typeof dialog.close === 'function') {
    dialog.close();
  }
}
```

### Template Usage

```html
<modus-button color="primary" (buttonClick)="openModal()">Open Modal</modus-button>
<modus-modal modalId="modal-id" [showClose]="true">
  <h3 slot="header">Modal Title</h3>
  <div slot="content">
    <p>Modal content here</p>
  </div>
  <div slot="footer">
    <modus-button color="secondary" (buttonClick)="closeModal()">Close</modus-button>
  </div>
</modus-modal>
```

### Why This Works

1. **Modal component creates dialog element**: The `modus-modal` wrapper component sets the `modalId` on the underlying `<modus-wc-modal>` web component
2. **Web component creates HTML dialog**: The web component creates an HTML `<dialog>` element with `id={modalId}`
3. **Use native dialog API**: The HTML `<dialog>` element has `showModal()` and `close()` methods - use these directly
4. **Type-safe with checks**: Type casting to `HTMLDialogElement | null` and checking for method existence ensures safety

---

## ❌ WRONG: Common Mistakes

### ❌ DON'T Use `querySelector` with Web Component Selector

```typescript
// ❌ WRONG: This doesn't work
openModal(): void {
  const modal = document.querySelector('modus-wc-modal[modal-id="modal-id"]') as any;
  if (modal) {
    modal.open(); // ❌ Web component doesn't have an open() method
  }
}
```

**Why this fails**:
- The web component (`modus-wc-modal`) doesn't expose an `open()` method
- The selector `modal-id` is an attribute, not the element's `id`
- This approach won't find the correct element

### ❌ DON'T Try to Access Web Component Methods Directly

```typescript
// ❌ WRONG: Web component doesn't expose these methods
const modal = document.querySelector('modus-wc-modal') as any;
modal.open(); // ❌ Method doesn't exist
modal.show(); // ❌ Method doesn't exist
```

### ❌ DON'T Use Template References on Wrapper Component

```typescript
// ❌ WRONG: Can't directly call methods on Angular wrapper
@ViewChild(ModusModalComponent) modal!: ModusModalComponent;
// ❌ ModusModalComponent doesn't expose open()/close() methods

openModal(): void {
  this.modal.open(); // ❌ Method doesn't exist
}
```

### ❌ DON'T Use `modalId` with Different Selectors

```typescript
// ❌ WRONG: modalId is used as id on dialog, not as attribute
const modal = document.querySelector('[modal-id="modal-id"]') as any;
const modal = document.querySelector('modus-modal[modal-id="modal-id"]') as any;
const modal = document.querySelector('modus-wc-modal[modal-id="modal-id"]') as any;
```

**Why these fail**:
- `modalId` is applied as the `id` attribute on the `<dialog>` element, not on the web component
- Must use `document.getElementById(modalId)` to find the dialog element

---

## ✅ Best Practices

### 1. Always Use `getElementById` with ModalId

**✅ CORRECT**:
```typescript
openModal(modalId: string): void {
  const dialog = document.getElementById(modalId) as HTMLDialogElement | null;
  if (dialog && typeof dialog.showModal === 'function') {
    dialog.showModal();
  }
}
```

**✅ CORRECT: Multiple modals with helper method**:
```typescript
export class ModalDemoPageComponent {
  private openModalById(modalId: string): void {
    const dialog = document.getElementById(modalId) as HTMLDialogElement | null;
    if (dialog && typeof dialog.showModal === 'function') {
      dialog.showModal();
    }
  }

  private closeModalById(modalId: string): void {
    const dialog = document.getElementById(modalId) as HTMLDialogElement | null;
    if (dialog && typeof dialog.close === 'function') {
      dialog.close();
    }
  }

  openBasicModal(): void {
    this.openModalById('basic-modal');
  }

  closeBasicModal(): void {
    this.closeModalById('basic-modal');
  }
}
```

### 2. Always Check for Method Existence

**✅ CORRECT: Type-safe with checks**:
```typescript
const dialog = document.getElementById('modal-id') as HTMLDialogElement | null;
if (dialog && typeof dialog.showModal === 'function') {
  dialog.showModal();
}
```

**Why**: 
- Ensures the element exists (`dialog` is not null)
- Ensures the method exists (browser support check)
- Type-safe with proper casting

### 3. Use Consistent ModalId Naming

**✅ CORRECT: Descriptive, kebab-case modal IDs**:
```typescript
<modus-modal modalId="basic-modal" />
<modus-modal modalId="confirmation-modal" />
<modus-modal modalId="fullscreen-modal" />
```

**❌ WRONG: Inconsistent naming**:
```typescript
<modus-modal modalId="modal1" /> // ❌ Not descriptive
<modus-modal modalId="basicModal" /> // ❌ Use kebab-case
<modus-modal modalId="BASIC_MODAL" /> // ❌ Use lowercase kebab-case
```

### 4. Close Modals in Button Handlers

**✅ CORRECT: Explicit close in footer buttons**:
```html
<modus-modal modalId="confirmation-modal">
  <div slot="footer">
    <modus-button color="secondary" (buttonClick)="closeModal()">Cancel</modus-button>
    <modus-button color="primary" (buttonClick)="handleConfirm()">Confirm</modus-button>
  </div>
</modus-modal>
```

```typescript
handleConfirm(): void {
  // Do confirmation logic
  this.closeModal(); // ✅ Explicitly close after action
}
```

---

## Common Patterns

### Pattern 1: Simple Open/Close

```typescript
export class SimpleModalComponent {
  openModal(): void {
    const dialog = document.getElementById('my-modal') as HTMLDialogElement | null;
    if (dialog && typeof dialog.showModal === 'function') {
      dialog.showModal();
    }
  }

  closeModal(): void {
    const dialog = document.getElementById('my-modal') as HTMLDialogElement | null;
    if (dialog && typeof dialog.close === 'function') {
      dialog.close();
    }
  }
}
```

### Pattern 2: Multiple Modals with Helper

```typescript
export class MultipleModalsComponent {
  private openModalById(modalId: string): void {
    const dialog = document.getElementById(modalId) as HTMLDialogElement | null;
    if (dialog && typeof dialog.showModal === 'function') {
      dialog.showModal();
    }
  }

  private closeModalById(modalId: string): void {
    const dialog = document.getElementById(modalId) as HTMLDialogElement | null;
    if (dialog && typeof dialog.close === 'function') {
      dialog.close();
    }
  }

  openBasicModal(): void {
    this.openModalById('basic-modal');
  }

  closeBasicModal(): void {
    this.closeModalById('basic-modal');
  }

  openConfirmationModal(): void {
    this.openModalById('confirmation-modal');
  }

  closeConfirmationModal(): void {
    this.closeModalById('confirmation-modal');
  }
}
```

### Pattern 3: Confirmation Modal with Action

```typescript
export class ConfirmationModalComponent {
  openConfirmationModal(): void {
    const dialog = document.getElementById('confirmation-modal') as HTMLDialogElement | null;
    if (dialog && typeof dialog.showModal === 'function') {
      dialog.showModal();
    }
  }

  closeConfirmationModal(): void {
    const dialog = document.getElementById('confirmation-modal') as HTMLDialogElement | null;
    if (dialog && typeof dialog.close === 'function') {
      dialog.close();
    }
  }

  handleDelete(): void {
    // Perform delete action
    alert('Item deleted!');
    this.closeConfirmationModal(); // ✅ Close after action
  }
}
```

### Pattern 4: Modal with Backdrop Handling

```html
<!-- ✅ Static backdrop - requires explicit close -->
<modus-modal modalId="static-modal" [backdrop]="'static'" [showClose]="true">
  <div slot="content">
    <p>This modal requires explicit close - can't click outside.</p>
  </div>
  <div slot="footer">
    <modus-button color="secondary" (buttonClick)="closeStaticModal()">Close</modus-button>
  </div>
</modus-modal>

<!-- ✅ Default backdrop - can click outside or press ESC -->
<modus-modal modalId="default-modal" [backdrop]="'default'" [showClose]="true">
  <div slot="content">
    <p>This modal can be closed by clicking outside or pressing ESC.</p>
  </div>
</modus-modal>
```

---

## Key Rules Summary

1. **✅ ALWAYS use `document.getElementById(modalId)`** - The modalId is used as the dialog element's id
2. **✅ ALWAYS cast to `HTMLDialogElement | null`** - Type-safe casting
3. **✅ ALWAYS check for method existence** - `typeof dialog.showModal === 'function'`
4. **✅ ALWAYS use `dialog.showModal()`** - Native HTMLDialogElement API
5. **✅ ALWAYS use `dialog.close()`** - Native HTMLDialogElement API
6. **❌ NEVER use `querySelector` with web component selectors**
7. **❌ NEVER try to call `open()` on the web component**
8. **❌ NEVER use ViewChild or template references on the wrapper component**

---

## Reference Implementation

**✅ Working Example** (from `src/app/components/demos/modal-demo-page.component.ts`):

```typescript
export class ModalDemoPageComponent {
  openBasicModal(): void {
    const dialog = document.getElementById('basic-modal') as HTMLDialogElement | null;
    if (dialog && typeof dialog.showModal === 'function') {
      dialog.showModal();
    }
  }

  closeBasicModal(): void {
    const dialog = document.getElementById('basic-modal') as HTMLDialogElement | null;
    if (dialog && typeof dialog.close === 'function') {
      dialog.close();
    }
  }
}
```

**Template**:
```html
<modus-button color="primary" (buttonClick)="openBasicModal()">Open Basic Modal</modus-button>
<modus-modal modalId="basic-modal" [showClose]="true">
  <h3 slot="header">Basic Modal</h3>
  <div slot="content">
    <p>Modal content here</p>
  </div>
  <div slot="footer">
    <modus-button color="secondary" (buttonClick)="closeBasicModal()">Cancel</modus-button>
    <modus-button color="primary" (buttonClick)="closeBasicModal()">Confirm</modus-button>
  </div>
</modus-modal>
```

---

## Additional Resources

- **Working Example**: `src/app/components/demos/modal-demo-page.component.ts`
- **Reference**: `src/app/components/theme-demo.component.ts` (line 1244-1249)
- **Modal Component**: `src/app/components/modus-modal.component.ts`
- **HTMLDialogElement API**: [MDN Documentation](https://developer.mozilla.org/en-US/docs/Web/API/HTMLDialogElement)

---

**Remember**: Modals use the native HTML `<dialog>` element API. Always use `document.getElementById(modalId)` to find the dialog element, then call `showModal()` or `close()` on it.
