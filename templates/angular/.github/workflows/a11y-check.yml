name: Check Accessibility

on:
  pull_request:
    branches: [main]

jobs:
  a11y-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Angular application
        run: npm run build

      - name: Install Puppeteer and axe-core
        run: npm install --save-dev puppeteer axe-core

      - name: Install http-server
        run: npm install --save-dev http-server

      - name: Start server and run accessibility tests
        run: |
          # Start http-server in background
          npx http-server dist/angular-vite/browser -p 4200 > /dev/null 2>&1 &
          SERVER_PID=$!

          # Wait for server to be ready
          sleep 5

          # Run accessibility tests
          node << EOF
          const puppeteer = require('puppeteer');
          const axeCore = require('axe-core');

          (async () => {
            try {
              const browser = await puppeteer.launch({ args: ['--no-sandbox'] });
              const page = await browser.newPage();

              // Helper function to delay (replaces deprecated waitForTimeout)
              const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

              // Routes to test for accessibility
              const routes = [
                '/',
                '/theme-demo',
                '/button-demo'
              ];

              let hasViolations = false;

              // Configure axe-core to disable specific rules
              const axeConfig = {
                runOnly: {
                  type: 'tag',
                  values: ['wcag2a', 'wcag2aa', 'wcag21a', 'wcag21aa', 'wcag22a', 'wcag22aa', 'best-practice']
                },
                rules: {
                  'document-title': { enabled: false },
                  'html-has-lang': { enabled: false },
                  'landmark-one-main': { enabled: false },
                  'page-has-heading-one': { enabled: false },
                  'region': { enabled: false }
                }
              };

              for (const route of routes) {
                const url = \`http://localhost:4200\${route}\`;
                console.log(\`Checking accessibility for: \${url}\`);

                try {
                  await page.goto(url, { waitUntil: 'networkidle0', timeout: 30000 });

                  // Wait for Angular to render
                  await delay(1000);

                  await page.evaluate(axeCore.source);
                  const results = await page.evaluate((config) => {
                    return axe.run(document, config);
                  }, axeConfig);

                  if (results.violations.length > 0) {
                    console.error(\`❌ Accessibility violations found in \${route}:\`);
                    results.violations.forEach(violation => {
                      console.error(\`  - \${violation.id}: \${violation.description}\`);
                      if (violation.nodes.length > 0) {
                        violation.nodes.forEach(node => {
                          console.error(\`    * \${node.html}\`);
                        });
                      }
                    });
                    hasViolations = true;
                  } else {
                    console.log(\`✅ No violations found in \${route}\`);
                  }
                } catch (error) {
                  console.error(\`❌ Error checking \${route}: \${error.message}\`);
                  hasViolations = true;
                }
              }

              await browser.close();

              if (hasViolations) {
                console.error('❌ Accessibility tests failed. Please fix the issues before merging.');
                process.exit(1);
              } else {
                console.log('✅ All accessibility tests passed!');
              }
            } catch (error) {
              console.error('❌ An error occurred:', error);
              process.exit(1);
            }
          })();
          EOF

          # Cleanup: Kill the server
          kill $SERVER_PID 2>/dev/null || true

      - name: Check test results
        if: failure()
        run: |
          echo "❌ Accessibility tests failed. Please fix the issues before merging."
          exit 1
